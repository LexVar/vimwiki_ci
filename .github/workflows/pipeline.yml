name: Pipeline

on:
  workflow_dispatch:

jobs:
  Dependencies:
    runs-on: self-hosted

    steps:
      - name: Install vimwiki markdown dependencies
        run: |
          mkdir -p /home/avalente/.vim/pack/plugins/start
          sudo dnf install python3 vim git -y
          pip3 install --user vimwiki_markdown

      - name: Install vimwiki
        run: |
          stat /home/avalente/.vim/pack/plugins/start/vimwiki || git clone https://github.com/vimwiki/vimwiki.git /home/avalente/.vim/pack/plugins/start/vimwiki

  Build:
    needs: Dependencies
    runs-on: self-hosted

    steps:
      - name: Clone repo
        uses: actions/checkout@v2
        with:
          path: 'tmp'

      - name: Clone notes repo
        uses: actions/checkout@v2
        with:
          path: 'notes'
          ref: 'master'
          repository: 'LexVar/notes'
          ssh-key: ${{ secrets.REPO_PRIVATE_KEY }}

      - name: Apply vimrc config
        run: |
          sed -i "s:\$VIMWIKI:$GITHUB_WORKSPACE/notes:" $GITHUB_WORKSPACE/tmp/.vimrc
          cp $GITHUB_WORKSPACE/tmp/.vimrc /home/avalente/

      - name: Generate html from markdown
        run: |
          cd $GITHUB_WORKSPACE/notes
          vim +VimwikiAll2HTML +q index.md

  Deploy:
    needs: Build
    runs-on: self-hosted

    steps:
      - name: Make dir '/var/www/html'
        run: sudo mkdir -p /var/www/html/
      
      - name: Copy to '/var/www/html'
        run: |
          sudo cp -r $GITHUB_WORKSPACE/notes/site_html/* /var/www/html/
        
      - name: Setup apache
        run: |
          sudo dnf install -y httpd
          sudo sed -i "s:Listen 80:Listen 81:" /etc/httpd/conf/httpd.conf
          sudo systemctl enable httpd
          sudo systemctl restart httpd
